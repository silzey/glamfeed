rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for admin email
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'reellookz@gmail.com';
    }

    // Unrestricted admin access to all documents. This is the first check.
    match /{document=**} {
      allow read, write: if isAdmin();
    }

    // --- Users Collection ---
    // Rules for the /users/{userId} path
    match /users/{userId} {
      // Allow anyone to read a single public user profile (get)
      allow get: if true;
      
      // Only the admin can query the entire users collection (list)
      allow list: if isAdmin();

      // An authenticated user can create their own profile document
      allow create: if request.auth != null && request.auth.uid == userId;
      
      // A user can only update their own profile document
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    // --- Products Collection ---
    // Rules for the /products/{productId} path
    match /products/{productId} {
      // Products are public information, so anyone can read them.
      allow read: if true;
    }

    // --- Nested Reviews Collection ---
    // Rules for the /users/{userId}/reviews/{reviewId} path
    match /users/{userId}/reviews/{reviewId} {
      // Anyone can read a review
      allow read: if true;
      
      // A user can only create, update, or delete their own review
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Nested Comments Collection ---
    // Rules for the /users/{userId}/reviews/{reviewId}/comments/{commentId} path
    match /users/{userId}/reviews/{reviewId}/comments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      
      // A user can only create, update, or delete their own comment.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Public Feed Collection (for denormalized posts) ---
    // This collection is used for the main public feed.
    match /feed/{postId} {
        // Anyone can read the main feed posts
        allow read: if true;

        // An authenticated user can create a post.
        allow create: if request.auth != null;

        // The original author of the post can update or delete it.
        // The resource.data.userId refers to the data of the document *before* the update.
        allow update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // --- Reports Collection (Admin Only) ---
    match /reports/{reportId} {
        // Only admin can read/write reports
        allow read, write: if isAdmin();
    }

    // --- Broadcasts Collection (Admin create, all users read) ---
    match /broadcasts/{broadcastId} {
        // Only admin can create broadcasts
        allow create: if isAdmin();
        // All authenticated users can read broadcasts
        allow read: if request.auth != null;
    }
  }
}
